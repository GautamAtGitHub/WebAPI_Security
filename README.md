# WebAPI Security demo

<b>`Authentication`</b> to prove the identity of the API consumer 

<b>`Authorization`</b> to determine what that identity has access to

# JavaScript Web Tokens (JWT) 
<link>https://jwt.io/</link>
JWT defines a safe way to share secure information between two parties.

## Steps to implement JWS tocken

### 1. Add two packages

Package to map JWS token with .Net identity model.

`dotnet add package System.IdentityModel.Tokens.Jwt`

Package to Enable application pipeline to implement authentication using JWS token with 'Bearer authentication' (Auth token in header)

`dotnet add package Microsoft.AspNetCore.Authentication.JwtBearer`

### 2. Add JWSBearer authentication in startup.cs

To keep the things simple I have kept token issuer in the same API just given a different port to it.

```cs

public void ConfigureServices(IServiceCollection services)
{
    services.AddMvc();

    services.AddAuthentication(options => {
        options.DefaultAuthenticateScheme = "JwtBearer";
        options.DefaultChallengeScheme = "JwtBearer";
    })
    .AddJwtBearer("JwtBearer", jwtBearerOptions =>
    {
        jwtBearerOptions.TokenValidationParameters = new TokenValidationParameters
        {
            ValidateIssuerSigningKey = true, // verify signature to avoid tampering
            IssuerSigningKey = new SymmetricSecurityKey(System.Text.Encoding.UTF8.GetBytes(SecretKEY_AES256)),

            ValidateIssuer = true,
            ValidIssuer = "http://localhost:5001", // site that makes the token

            ValidateAudience = true,
            ValidAudience = "http://localhost:5000", // site that consumes the token

            ValidateLifetime = true, //validate the expiration and not before values in the token

            ClockSkew = System.TimeSpan.FromMinutes(5) //5 minute tolerance for the expiration date
        };
    });
}
        
```

### 3. Add `app.UseAuthentication();` in configure method

### 4. Add `[Authorize]` attribute to the controller or controller methor which you want to protect

### 5. Generate sample token

For this demo I have written sample code to create random token. In case of production we can use third party token provider such as Forms authentication or OAuth

```cs
[Route("GetToken")]
[HttpGet]
public IActionResult GetToken()
{
    var claims = new[]
    {
        new Claim(JwtRegisteredClaimNames.Sub, "jeremy@jeremylikness.com"),
        new Claim(JwtRegisteredClaimNames.Jti, System.Guid.NewGuid().ToString()),
    };

    var key = new SymmetricSecurityKey(System.Text.Encoding.UTF8.GetBytes(Startup.SecretKEY_AES256));
    var creds = new SigningCredentials(key, SecurityAlgorithms.HmacSha256);

    var token = new JwtSecurityToken("http://localhost:5001",
        "http://localhost:5000",
        claims,
        expires: System.DateTime.Now.AddMinutes(30),
        signingCredentials: creds);

    var tokenEncoded = new JwtSecurityTokenHandler().WriteToken(token);

    return new OkObjectResult(new { token = tokenEncoded });
}
```
![image](https://user-images.githubusercontent.com/34414643/39533059-c16ce202-4e4b-11e8-9ade-63c87f344df4.png)

### 6. Use the token to validate subsequent request

We can copy token the generated by this method and use it in next request with `Authorization:bearer {token}`

Authorization successful!
![image](https://user-images.githubusercontent.com/34414643/39533202-24ef0d46-4e4c-11e8-8930-a34305c25476.png)
